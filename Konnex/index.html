<!DOCTYPE html>
<html>

<head>
    <title>Konnex Widget</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chatStyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

</head>
<script language="javascript" type="text/javascript">
    var WEBSITEID = "12233";
    var wsUri = "wss://airbus-hackathon-backend.ganeshkumar269.repl.co/?website_id=" + WEBSITEID;
    var WEBSOCKETFLAG = "";
    var NAVIGATETO = "";
    var TOKEN = "";

    function displayKeywordChoices(keywords) {
        var list = document.getElementById('pred-list');
        var jsonKeywords = JSON.parse(keywords);
        console.log(keywords);
        list.innerHTML = "";
        for (var key in jsonKeywords) {
            console.log("<option value=\"" + key + "\"> ");
            list.innerHTML += "<option value=\"" + key + "\"> ";
        }
    }

    function NavigateToWebpage() {}

    function initSocket() {

        console.log("Socket setup");
        websocket = new WebSocket(wsUri);

        websocket.onopen = function(evt) {
            console.log("CONNECTED");
        };

        websocket.onmessage = function(evt) {
            if (WEBSOCKETFLAG == "navsearch") {
                displayKeywordChoices(evt.data);
            } else if (WEBSOCKETFLAG == "chatbot") {
                botResponse(evt.data);
            }
            console.log(evt.data);

        };

        websocket.onerror = function(evt) {
            console.log(evt.data);
        };

        console.log("EVENTS SETUP DONE")
    }

    function sendText() {
        var text = document.navform.navsearch.value;
        if (text != "") {
            var jsonMsg = {
                "navsearch": true,
                "searchText": text
            };
            var strJson = JSON.stringify(jsonMsg);

            console.log("TRYING TO SEND: " + strJson);

            websocket.send(strJson);
            WEBSOCKETFLAG = "navsearch";

            console.log("SENT: " + strJson);
        }
    }

    window.addEventListener("load", initSocket, false);
</script>

<body>

    <div id="widget-container">

        <span id="widget-button" onclick="ExpandWidget();"><img id="widget-logo" src="imgs/logo.jpg "></span>

        <div id="widget-popup-container" style="display: none;">
            <div class="feature-window" id="HomeDiv" style="display: block;">
                <p class="feature-heading">WHAT CAN I HELP YOU WITH?</p>
                <div class="feature-content">
                    <form class="searchbox" name="navform">
                        <input list="pred-list" type="text" id="navsearch" placeholder="Navigate on the website..." onkeyup="sendText();">
                        <datalist id="pred-list"></datalist>
                        <button type="button" onclick="NavigateToWebpage();"><i class="fa fa-search"></i></button>
                    </form>
                    <ul>
                        <li data-id="chatbot" onclick="ToggleWindow(this)">
                            <img data-id="chatbot" src="imgs/bot.png " width="35px" height="35px" onclick="ToggleWindow(this)">CHAT WITH US</li>
                        <li data-id="feedback" onclick="ToggleWindow(this)">
                            <img data-id="feedback" src="imgs/idea.png " width="35px" height="35px" onclick="ToggleWindow(this)">GOT A FEEDBACK?</li>
                        <li data-id="reportbug" onclick="ToggleWindow(this)">
                            <img data-id="reportbug" src="imgs/bug.png " width="35px" height="35px" onclick="ToggleWindow(this)">REPORT A BUG</li>
                        <li data-id="announcements" onclick="ToggleWindow(this)">
                            <img data-id="announcements" src="imgs/announce.png " width="35px" height="35px" onclick="ToggleWindow(this)">CHECK ANNOUNCEMENT</li>
                    </ul>
                </div>
            </div>

            <div class="feature-window" id="ChatbotDiv" style="display: none;">
                <p class="feature-heading"><span style="float: left;"><i class="fa fa-home" onclick="GoHome();"></i></span>CHAT WITH US</p>
                <div class="feature-content">
                    <section class="msger">
                        <header class="msger-header">
                            <div class="msger-header-title">
                                <i class="fas fa-comment-alt"></i> KonnexChat
                            </div>
                            <div class="msger-header-options">
                                <span><i class="fas fa-cog"></i></span>
                            </div>
                        </header>

                        <main class="msger-chat">
                            <div class="msg left-msg">
                                <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)"></div>

                                <div class="msg-bubble">
                                    <div class="msg-info">
                                        <div class="msg-info-name">BOT</div>
                                        <div class="msg-info-time">12:45</div>
                                    </div>

                                    <div class="msg-text">
                                        Hi, welcome to SimpleChat! Go ahead and send me a message. ðŸ˜„
                                    </div>
                                </div>
                            </div>

                            <div class="msg right-msg">
                                <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/145/145867.svg)"></div>

                                <div class="msg-bubble">
                                    <div class="msg-info">
                                        <div class="msg-info-name">Sajad</div>
                                        <div class="msg-info-time">12:46</div>
                                    </div>

                                    <div class="msg-text">
                                        You can talk to us like this!
                                    </div>
                                </div>
                            </div>
                        </main>

                        <form name="chatboxmsg" class="msger-inputarea">
                            <input id="inputChatbox" type="text" class="msger-input" placeholder="Enter your message...">
                            <button type="submit" onclick="ChatResp();" class="msger-send-btn">Send</button>
                        </form>
                    </section>
                </div>
            </div>

            <div class="feature-window" id="FeedbackDiv" style="display: none;">
                <p class="feature-heading"><span style="float: left;"><i class="fa fa-home" onclick="GoHome();"></i></span>GIVE A FEEDBACK</p>
                <div class="feature-content">
                    <form name="feedbackform" class="align-form">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-control" id="feedbackTitleInput" placeholder="Enter a title">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" class="form-control" id="feedbackDescInput" placeholder="Feedback Description">
                        </div>
                        <div style="text-align: center;"><button type="button" class="btn btn-primary" onclick="SendFeedback();">Submit</button></div>
                    </form>
                </div>
            </div>

            <div class="feature-window" id="ReportBugDiv" style="display: none;">
                <p class="feature-heading"><span style="float: left;"><i class="fa fa-home" onclick="GoHome();"></i></span>REPORT A BUG</p>
                <div class="feature-content">
                    <form name="reportbugform" class="align-form">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-control" id="reportTitleInput" placeholder="Enter issue title">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" class="form-control" id="reportDescInput" placeholder="Description">
                        </div>
                        <div style="text-align: center;"><button type="button" class="btn btn-primary" onclick="SendReport();">Submit</button></div>
                    </form>
                </div>
            </div>

            <div class="feature-window" id="AnnouncementDiv" style="display: none;">
                <p class="feature-heading"><span style="float: left;"><i class="fa fa-home" onclick="GoHome();"></i></span>ANNOUNCEMENTS</p>
                <div class="feature-content">
                    <ul id="announcementsList">
                    </ul>
                </div>
            </div>

            <div class="feature-window" id="loginDiv" style="display: none;">
                <p class="feature-heading"><span style="float: left;"><i class="fa fa-home" onclick="GoHome();"></i></span>SIGNIN</p>
                <div class="feature-content">
                    <form name="loginform" class="align-form">
                        <div class="form-group">
                            <label>EMAIL-ID</label>
                            <input type="text" class="form-control" id="emailidInput" placeholder="example@email.com">
                        </div>
                        <div class="form-group">
                            <label>PASSWORD</label>
                            <input type="password" class="form-control" id="passwordInput" placeholder="password">
                        </div>
                        <div style="text-align: center;"><button type="button" class="btn btn-primary" onclick="submitLoginForm();">SIGNIN</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>
<script type="text/javascript">
    function CheckLogin() {
        var token = window.localStorage.getItem("token");
        if (token == null) {
            document.getElementById("HomeDiv").style.display = "none";
            document.getElementById("loginDiv").style.display = "block";
        } else {
            console.log("REDIRECTING TO " + NAVIGATETO);
            document.getElementById("HomeDiv").style.display = "none";
            document.getElementById(NAVIGATETO).style.display = "block";
        }
    }

    function submitLoginForm() {
        var user_email = document.getElementById("emailidInput").value
        var user_password = document.getElementById("passwordInput").value

        if (user_email && user_password) {
            var url = 'https://airbus-hackathon-backend.ganeshkumar269.repl.co/api/v1/login';
            var jsonDetails = {
                "website_id": "12233",
                "email": user_email,
                "password": user_password
            }
            console.log("Will try to send login details ", jsonDetails);

            async function loginData() {
                let response = await fetch(
                    url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(jsonDetails)
                    }
                );
                let data = await response.json();
                return data;
            }
            loginData().then(data => SetToken(data.token));

            document.getElementById("loginDiv").style.display = "none";
            document.getElementById(NAVIGATETO).style.display = "block";
        }
    }

    function SetToken(tokenData) {
        console.log(tokenData);
        TOKEN = tokenData;
        window.localStorage.setItem('token', TOKEN);
    }

    function ChatResp() {
        var text = document.getElementById("inputChatbox").value;
        console.log(text);
        if (text != "") {
            var jsonMsg = {
                "chatbot": true,
                "searchText": text
            }
            var strJson = JSON.stringify(jsonMsg);

            console.log("TRYING TO SEND: " + strJson);

            websocket.send(strJson);
            WEBSOCKETFLAG = "chatbot";

            console.log("SENT: " + strJson);
        }
    }

    function SendFeedback() {
        var url = 'https://airbus-hackathon-backend.ganeshkumar269.repl.co/api/v1/feedback';
        var feedbackStr = document.getElementById("feedbackTitleInput").value;
        var feedbackDescStr = document.getElementById("feedbackDescInput").value;
        if (feedbackStr && feedbackDescStr) {

            var user_email = "example@email.com";
            feedback = {
                "website_id": WEBSITEID,
                "email": user_email,
                "feedbackTitle": feedbackStr,
                "feedbackDesc": feedbackDescStr
            }

            console.log("Will try to send feedback ", feedback);

            async function postFeedbackData() {
                let response = await fetch(
                    url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + TOKEN
                        },
                        body: JSON.stringify(feedback)
                    }
                );
                let data = await response.json();
                return data;
            }
            postFeedbackData().then(data => console.log("Request complete! response:", data));
        }
    }

    function SendReport() {
        var url = 'https://airbus-hackathon-backend.ganeshkumar269.repl.co/api/v1/bugreport';
        var reportStr = document.getElementById("reportTitleInput").value;
        var reportDescStr = document.getElementById("reportDescInput").value;
        if (reportStr && reportDescStr) {
            console.log("About to send report")

            var user_email = "example@email.com";
            bugReport = {
                "website_id": WEBSITEID,
                "email": user_email,
                "bugReportTitle": reportStr,
                "bugReportDesc": reportDescStr
            }

            console.log("Will try to send report ", bugReport);

            async function postReportData() {
                let response = await fetch(
                    url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + TOKEN
                        },
                        body: JSON.stringify(bugReport)
                    }
                );
                let data = await response.json();
                return data;
            }
            postReportData().then(data => console.log("Request complete! response:", data));
        }
    }

    function GetAnnouncements() {
        async function getAnnouncementData() {
            var url = 'https://airbus-hackathon-backend.ganeshkumar269.repl.co/api/v1/announcement?website_id=' + WEBSITEID;
            let response = await fetch(
                url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + TOKEN
                    }
                }
            );
            let data = await response.json();
            return data;
        }
        getAnnouncementData().then(data => AnnouncementActions(data));
    }

    function AnnouncementActions(data) {
        console.log("Announcements:", data);
        var announcementsList = document.getElementById('announcementsList');
        announcementsList.innerHTML = "";

        for (var i = 0; i < data.length; i++) {
            announcementsList.innerHTML += "<li>" + data[i] + "</li>";
        }
    }

    function ExpandWidget() {
        if (document.getElementById("widget-popup-container").style.display == "none") {
            document.getElementById("widget-popup-container").style.display = "block";
        } else {
            document.getElementById("widget-popup-container").style.display = "none";
        }
    }

    function ToggleWindow(elem) {
        console.log("Enter")
        var element_id = elem.getAttribute("data-id");
        console.log(element_id);
        if (element_id == "chatbot") {
            NAVIGATETO = "ChatbotDiv";
            CheckLogin();
        } else if (element_id == "feedback") {
            NAVIGATETO = "FeedbackDiv";
            CheckLogin();
        } else if (element_id == "reportbug") {
            NAVIGATETO = "ReportBugDiv";
            CheckLogin();
        } else if (element_id == "announcements") {
            NAVIGATETO = "AnnouncementDiv";
            GetAnnouncements();
            document.getElementById("HomeDiv").style.display = "none";
            document.getElementById("AnnouncementDiv").style.display = "block";
        }
    }

    function GoHome() {
        NAVIGATETO = "HomeDiv";
        document.getElementById("HomeDiv").style.display = "block";
        document.getElementById("ChatbotDiv").style.display = "none";
        document.getElementById("FeedbackDiv").style.display = "none";
        document.getElementById("ReportBugDiv").style.display = "none";
        document.getElementById("AnnouncementDiv").style.display = "none";
    }

    let msgerForm = get(".msger-inputarea");
    let msgerInput = get(".msger-input");
    let msgerChat = get(".msger-chat");

    const BOT_IMG = "https://image.flaticon.com/icons/svg/327/327779.svg";
    const PERSON_IMG = "https://image.flaticon.com/icons/svg/145/145867.svg";
    const BOT_NAME = "BOT";
    const PERSON_NAME = "YOU";

    msgerForm.addEventListener("submit", event => {
        event.preventDefault();
        const msgText = msgerInput.value;
        if (!msgText) return;
        appendMessage(PERSON_NAME, PERSON_IMG, "right", msgText);
        msgerInput.value = "";
    });

    function appendMessage(name, img, side, text) {
        const msgHTML = `
                <div class="msg ${side}-msg">
                <div class="msg-img" style="background-image: url(${img})"></div>

                <div class="msg-bubble">
                    <div class="msg-info">
                    <div class="msg-info-name">${name}</div>
                    <div class="msg-info-time">${formatDate(new Date())}</div>
                    </div>

                    <div class="msg-text">${text}</div>
                </div>
                </div>
            `;

        msgerChat.insertAdjacentHTML("beforeend", msgHTML);
        msgerChat.scrollTop += 500;
    }

    function botResponse(msgText) {
        const delay = msgText.split(" ").length * 100;

        setTimeout(() => {
            appendMessage(BOT_NAME, BOT_IMG, "left", msgText);
        }, delay);
    }

    function get(selector, root = document) {
        return root.querySelector(selector);
    }

    function formatDate(date) {
        const h = "0" + date.getHours();
        const m = "0" + date.getMinutes();

        return `${h.slice(-2)}:${m.slice(-2)}`;
    }

    function random(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
    }
</script>

</html>

</html>